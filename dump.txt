<?php
require_once 'config.php';

function sanitizeInput($input)
{
    $input = trim($input);
    $input = stripslashes($input);
    $input = htmlspecialchars($input);
    return $input;
}

if ($_SERVER["REQUEST_METHOD"] == "POST") {


    $name = sanitizeInput($_POST["name"]);
    $email = sanitizeInput($_POST["email"]);
    $schoolID = sanitizeInput($_POST["schoolID"]);
    $password = sanitizeInput($_POST["password"]);
    $mobilenumber = sanitizeInput($_POST["mobile_number"]);
    $role = "student";
    $status = "Pending";

    // Generate a unique verification token
    $verificationToken = bin2hex(random_bytes(16));

    $checkQuery = "SELECT * FROM users WHERE email = ?";
    $stmt = $connection->prepare($checkQuery);
    $stmt->bind_param("s", $email);
    $stmt->execute();
    $stmt->store_result();

    if ($stmt->num_rows == 0) {
        // User doesn't exist, proceed with registration
        $currentDate = date("Y-m-d"); // Get the current date

        $insertQuery = "INSERT INTO users (name, email, schoolID, role, password, profile_image, mobile_number, datecreated, status, verification_token) 
                        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
        $stmt = $connection->prepare($insertQuery);
        $stmt->bind_param("sssssbssss", $name, $email, $schoolID, $role, $password, $profileImage, $mobilenumber, $currentDate, $status, $verificationToken);
        $insertResult = $stmt->execute();

        if ($insertResult) {
            $verificationLink = "http://localhost/cpu_enterprise_inventory/verify.php?token=" . $verificationToken;
            $subject = "Email Verification";
            $message = "Please click the following link to verify your email address: $verificationLink";
            mail($email, $subject, $message);

            header("Location: index.php");
            exit();
        } else {
            die("Error: " . mysqli_error($connection));
        }
    } else {
        echo "Email already exists. Please use a different email.";
    }
}
?>